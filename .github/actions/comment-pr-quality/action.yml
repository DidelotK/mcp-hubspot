name: 'Comment PR with Code Quality Report'
description: 'Post or update a comment on PR with code quality analysis results'
author: 'HubSpot MCP Server Team'

inputs:
  report-path:
    description: 'Path to the code quality report file (markdown format)'
    required: true
    default: 'lint_report.md'
  
  github-token:
    description: 'GitHub token for API access'
    required: true
    default: ${{ github.token }}

runs:
  using: 'composite'
  steps:
    - name: Read quality report
      id: read-report
      shell: bash
      run: |
        if [ -f "${{ inputs.report-path }}" ]; then
          # Lire le rapport et l'encoder pour √©viter les probl√®mes avec les caract√®res sp√©ciaux
          REPORT_CONTENT=$(cat "${{ inputs.report-path }}")
          echo "report-exists=true" >> $GITHUB_OUTPUT
          # √âchapper les caract√®res sp√©ciaux pour GitHub Actions
          {
            echo 'report-content<<EOF'
            echo "$REPORT_CONTENT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
        else
          echo "report-exists=false" >> $GITHUB_OUTPUT
          echo 'report-content=## ‚ùå Erreur lors de la v√©rification de la qualit√© du code\n\nImpossible de g√©n√©rer le rapport de qualit√©.' >> $GITHUB_OUTPUT
        fi

    - name: Find existing quality comment
      id: find-comment
      uses: peter-evans/find-comment@v3
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: 'V√©rification de la qualit√© du code'
        token: ${{ inputs.github-token }}

    - name: Create or update PR comment
      uses: peter-evans/create-or-update-comment@v4
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ${{ steps.read-report.outputs.report-content }}
          
          ---
          *ü§ñ Ce commentaire est g√©n√©r√© automatiquement par la CI. Il sera mis √† jour √† chaque push.*
        edit-mode: replace
        token: ${{ inputs.github-token }}

    - name: Report action status
      shell: bash
      run: |
        if [ "${{ steps.read-report.outputs.report-exists }}" = "true" ]; then
          echo "‚úÖ Rapport de qualit√© post√©/mis √† jour sur la PR"
        else
          echo "‚ùå Impossible de lire le rapport de qualit√©"
          exit 1
        fi